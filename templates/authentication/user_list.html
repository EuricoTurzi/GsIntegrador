{% extends 'base.html' %}

{% block title %}Usuários - Sistema Integrador GR{% endblock %}

{% block page_title %}Gerenciar Usuários{% endblock %}

{% block breadcrumbs %}
<nav class="flex mb-6" aria-label="Breadcrumb">
  <ol class="inline-flex items-center space-x-1 md:space-x-3">
    <li class="inline-flex items-center">
      <a
        href="{% url 'dashboard' %}"
        class="text-gray-600 hover:text-primary-600 transition-colors"
      >
        <i class="fas fa-home mr-2"></i>Dashboard
      </a>
    </li>
    <li>
      <div class="flex items-center">
        <i class="fas fa-chevron-right text-gray-400 text-xs mx-2"></i>
        <span class="text-gray-700 font-medium">Usuários</span>
      </div>
    </li>
  </ol>
</nav>
{% endblock %}

{% block content %}

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-2">
      <div
        class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-users text-blue-600 text-xl"></i>
      </div>
    </div>
    <h3 class="text-gray-600 text-sm font-medium">Total de Usuários</h3>
    <p class="text-3xl font-bold text-gray-900 mt-2">
      {{ stats.total|default:0 }}
    </p>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-2">
      <div
        class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-user-check text-green-600 text-xl"></i>
      </div>
    </div>
    <h3 class="text-gray-600 text-sm font-medium">Ativos</h3>
    <p class="text-3xl font-bold text-gray-900 mt-2">
      {{ stats.active|default:0 }}
    </p>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-2">
      <div
        class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-shield-alt text-purple-600 text-xl"></i>
      </div>
    </div>
    <h3 class="text-gray-600 text-sm font-medium">GR (Admin)</h3>
    <p class="text-3xl font-bold text-gray-900 mt-2">
      {{ stats.gr|default:0 }}
    </p>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-2">
      <div
        class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-building text-yellow-600 text-xl"></i>
      </div>
    </div>
    <h3 class="text-gray-600 text-sm font-medium">Transportadoras</h3>
    <p class="text-3xl font-bold text-gray-900 mt-2">
      {{ stats.transportadora|default:0 }}
    </p>
  </div>
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-200">
  <!-- Header with Search and Filters -->
  <div class="p-6 border-b border-gray-200">
    <div
      class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
    >
      <!-- Search -->
      <div class="flex-1 max-w-md">
        <form method="get" class="relative">
          <div
            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
          >
            <i class="fas fa-search text-gray-400"></i>
          </div>
          <input
            type="text"
            name="search"
            value="{{ request.GET.search }}"
            placeholder="Buscar por nome, email ou username..."
            class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </form>
      </div>

      <!-- Filters and Actions -->
      <div class="flex items-center space-x-3">
        <!-- Type Filter -->
        <div x-data="{ open: false }" class="relative">
          <button
            @click="open = !open"
            class="inline-flex items-center px-4 py-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500"
          >
            <i class="fas fa-filter mr-2"></i>
            Tipo
            <i class="fas fa-chevron-down ml-2 text-xs"></i>
          </button>

          <div
            x-show="open"
            @click.away="open = false"
            x-transition
            class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-10"
          >
            <div class="py-1">
              <a
                href="?user_type=all"
                class="flex items-center px-4 py-3 hover:bg-gray-50"
              >
                <span class="text-sm text-gray-700">Todos os tipos</span>
              </a>
              <a
                href="?user_type=GR"
                class="flex items-center px-4 py-3 hover:bg-gray-50"
              >
                <i class="fas fa-shield-alt mr-3 text-purple-600"></i>
                <span class="text-sm text-gray-700">GR (Admin)</span>
              </a>
              <a
                href="?user_type=TRANSPORTADORA"
                class="flex items-center px-4 py-3 hover:bg-gray-50"
              >
                <i class="fas fa-building mr-3 text-blue-600"></i>
                <span class="text-sm text-gray-700">Transportadora</span>
              </a>
            </div>
          </div>
        </div>

        <!-- Status Filter -->
        <div x-data="{ open: false }" class="relative">
          <button
            @click="open = !open"
            class="inline-flex items-center px-4 py-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500"
          >
            <i class="fas fa-toggle-on mr-2"></i>
            Status
            <i class="fas fa-chevron-down ml-2 text-xs"></i>
          </button>

          <div
            x-show="open"
            @click.away="open = false"
            x-transition
            class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10"
          >
            <div class="py-1">
              <a
                href="?status=all"
                class="flex items-center px-4 py-3 hover:bg-gray-50"
              >
                <span class="text-sm text-gray-700">Todos</span>
              </a>
              <a
                href="?status=active"
                class="flex items-center px-4 py-3 hover:bg-gray-50"
              >
                <span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span>
                <span class="text-sm text-gray-700">Ativos</span>
              </a>
              <a
                href="?status=inactive"
                class="flex items-center px-4 py-3 hover:bg-gray-50"
              >
                <span class="w-2 h-2 bg-red-500 rounded-full mr-3"></span>
                <span class="text-sm text-gray-700">Inativos</span>
              </a>
            </div>
          </div>
        </div>

        <!-- Add User Button -->
        <a
          href="{% url 'authentication:register' %}"
          class="inline-flex items-center px-4 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium"
        >
          <i class="fas fa-plus mr-2"></i>
          Novo Usuário
        </a>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th
            scope="col"
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Usuário
          </th>
          <th
            scope="col"
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Email
          </th>
          <th
            scope="col"
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Tipo
          </th>
          <th
            scope="col"
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Status
          </th>
          <th
            scope="col"
            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Último Acesso
          </th>
          <th
            scope="col"
            class="px-6 py-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
          >
            Ações
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for user in users %}
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 w-10 h-10">
                <div
                  class="w-10 h-10 bg-gradient-to-br from-primary-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold"
                >
                  {{ user.username|slice:":2"|upper }}
                </div>
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">
                  {{ user.username }}
                </div>
                {% if user.first_name or user.last_name %}
                <div class="text-sm text-gray-500">
                  {{ user.first_name }} {{ user.last_name }}
                </div>
                {% endif %}
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">{{ user.email }}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if user.is_superuser or user.user_type == 'GR' %}bg-purple-100 text-purple-800 {% else %}bg-blue-100 text-blue-800{% endif %}"
            >
              <i
                class="fas {% if user.is_superuser or user.user_type == 'GR' %}fa-shield-alt{% else %}fa-building{% endif %} mr-1"
              ></i>
              {% if user.is_superuser %}
                Super
              {% elif user.user_type == 'GR' %}
                GR
              {% else %}
                Transp.
              {% endif %}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if user.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}"
            >
              <span
                class="w-2 h-2 rounded-full mr-1.5 {% if user.is_active %}bg-green-500{% else %}bg-red-500{% endif %}"
              ></span>
              {% if user.is_active %}Ativo{% else %}Inativo{% endif %}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            {% if user.last_login %}
              {{ user.last_login|date:"d/m/Y H:i" }}
            {% else %}
              <span class="text-gray-400">Nunca</span>
            {% endif %}
          </td>
          <td
            class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"
          >
            <div class="flex items-center justify-end space-x-2">
              <a
                href="{% url 'authentication:user-detail' user.id %}"
                class="text-primary-600 hover:text-primary-900 transition-colors"
                title="Ver detalhes"
              >
                <i class="fas fa-eye"></i>
              </a>
              <a
                href="{% url 'authentication:user-edit' user.id %}"
                class="text-blue-600 hover:text-blue-900 transition-colors"
                title="Editar"
              >
                <i class="fas fa-edit"></i>
              </a>
              {% if user.is_active %}
              <button
                onclick="if(confirm('Desativar usuário {{ user.username }}?')) { /* deactivate */ }"
                class="text-red-600 hover:text-red-900 transition-colors"
                title="Desativar"
              >
                <i class="fas fa-user-times"></i>
              </button>
              {% else %}
              <button
                onclick="if(confirm('Ativar usuário {{ user.username }}?')) { /* activate */ }"
                class="text-green-600 hover:text-green-900 transition-colors"
                title="Ativar"
              >
                <i class="fas fa-user-check"></i>
              </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="px-6 py-12 text-center">
            <div class="flex flex-col items-center">
              <i class="fas fa-users text-gray-300 text-5xl mb-4"></i>
              <p class="text-gray-500 text-lg mb-2">
                Nenhum usuário encontrado
              </p>
              <p class="text-gray-400 text-sm">
                Tente ajustar os filtros ou adicionar um novo usuário
              </p>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if users.has_other_pages %}
  <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
    <div class="flex items-center justify-between">
      <div class="text-sm text-gray-700">
        Mostrando
        <span class="font-medium">{{ users.start_index }}</span>
        até
        <span class="font-medium">{{ users.end_index }}</span>
        de
        <span class="font-medium">{{ users.paginator.count }}</span>
        resultados
      </div>

      <nav
        class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px"
        aria-label="Pagination"
      >
        {% if users.has_previous %}
        <a
          href="?page={{ users.previous_page_number }}"
          class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          <i class="fas fa-chevron-left"></i>
        </a>
        {% else %}
        <span
          class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed"
        >
          <i class="fas fa-chevron-left"></i>
        </span>
        {% endif %}
        
        {% for num in users.paginator.page_range %}
          {% if users.number == num %}
            <span
              class="relative inline-flex items-center px-4 py-2 border border-primary-500 bg-primary-50 text-sm font-medium text-primary-600"
            >
              {{ num }}
            </span>
          {% elif num > users.number|add:-3 and num < users.number|add:3 %}
            <a
              href="?page={{ num }}"
              class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              {{ num }}
            </a>
          {% endif %}
        {% endfor %}
        
        {% if users.has_next %}
        <a
          href="?page={{ users.next_page_number }}"
          class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          <i class="fas fa-chevron-right"></i>
        </a>
        {% else %}
        <span
          class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed"
        >
          <i class="fas fa-chevron-right"></i>
        </span>
        {% endif %}
      </nav>
    </div>
  </div>
  {% endif %}
</div>

{% endblock %}
