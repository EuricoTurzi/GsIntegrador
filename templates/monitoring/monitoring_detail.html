{% extends 'base.html' %}

{% block title %}{{ trip.identifier }} - {{ trip.name }}{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header com Ações -->
    <div class="flex justify-between items-start">
        <div>
            <div class="flex items-center space-x-3">
                <a href="{% url 'monitoring_list' %}" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                </a>
                <h1 class="text-3xl font-bold text-gray-900">{{ trip.identifier }}</h1>
                {% if trip.status == 'PLANEJADO' %}
                <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                    Planejado
                </span>
                {% elif trip.status == 'EM_ANDAMENTO' %}
                <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                    Em Andamento
                </span>
                {% elif trip.status == 'CONCLUIDO' %}
                <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                    Concluído
                </span>
                {% else %}
                <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                    Cancelado
                </span>
                {% endif %}
            </div>
            <p class="mt-2 text-sm text-gray-600">{{ trip.name }}</p>
        </div>
        
        <div class="flex space-x-2">
            {% if trip.status == 'PLANEJADO' %}
            <form method="post" action="{% url 'monitoring_start' trip.pk %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
                    <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Iniciar Viagem
                </button>
            </form>
            {% elif trip.status == 'EM_ANDAMENTO' %}
            <form method="post" action="{% url 'monitoring_complete' trip.pk %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                    <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Concluir Viagem
                </button>
            </form>
            {% endif %}
            
            {% if trip.status in 'PLANEJADO,EM_ANDAMENTO' %}
            <a href="{% url 'monitoring_edit' trip.pk %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Editar
            </a>
            {% endif %}
            
            <a href="{% url 'monitoring_delete' trip.pk %}" class="inline-flex items-center px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50">
                <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Excluir
            </a>
        </div>
    </div>

    <!-- Grid Principal -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Coluna Esquerda - Mapa e Tracking -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Mapa -->
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-900">Tracking em Tempo Real</h2>
                    {% if trip.status == 'EM_ANDAMENTO' %}
                    <button onclick="refreshPosition()" class="text-sm text-blue-600 hover:text-blue-800">
                        <svg class="inline h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Atualizar Posição
                    </button>
                    {% endif %}
                </div>
                <div id="tracking-map" class="h-96"></div>
                
                {% if current_position %}
                <div class="px-6 py-4 bg-gray-50 border-t">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Velocidade:</span>
                            <span class="ml-2 font-semibold">{{ current_position.speed|default:"0" }} km/h</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Última Atualização:</span>
                            <span class="ml-2 font-semibold">{{ current_position.last_update|date:"H:i" }}</span>
                        </div>
                        <div class="col-span-2">
                            <span class="text-gray-600">Endereço:</span>
                            <span class="ml-2 font-semibold">{{ current_position.address|default:"Carregando..." }}</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Informações da Rota -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Informações da Rota</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full bg-green-100 flex items-center justify-center">
                            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-500">Origem</p>
                            <p class="text-sm font-semibold text-gray-900">{{ trip.route.origin_name }}</p>
                            <p class="text-xs text-gray-500">{{ trip.route.origin_address }}</p>
                        </div>
                    </div>

                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full bg-red-100 flex items-center justify-center">
                            <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-500">Destino</p>
                            <p class="text-sm font-semibold text-gray-900">{{ trip.route.destination_name }}</p>
                            <p class="text-xs text-gray-500">{{ trip.route.destination_address }}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Distância:</span>
                        <span class="ml-2 font-semibold">{{ trip.route.distance_km }} km</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Tempo Estimado:</span>
                        <span class="ml-2 font-semibold">{{ trip.route.estimated_duration_hours|floatformat:1 }}h</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coluna Direita - Informações -->
        <div class="space-y-6">
            <!-- Motorista -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Motorista</h3>
                <div class="flex items-center space-x-4">
                    <div class="h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900">{{ trip.driver.name }}</p>
                        <p class="text-sm text-gray-500">CNH: {{ trip.driver.cnh }}</p>
                    </div>
                </div>
                <a href="{% url 'drivers-detail' trip.driver.pk %}" class="mt-4 block text-center text-sm text-blue-600 hover:text-blue-800">
                    Ver Perfil →
                </a>
            </div>

            <!-- Veículo -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Veículo</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Placa:</span>
                        <span class="text-sm font-semibold">{{ trip.vehicle.plate }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Modelo:</span>
                        <span class="text-sm font-semibold">{{ trip.vehicle.model }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Status:</span>
                        <span class="text-sm font-semibold">{{ trip.vehicle.get_status_display }}</span>
                    </div>
                    {% if trip.vehicle.device %}
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Rastreador:</span>
                        {% if trip.vehicle.device.is_updated_recently %}
                        <span class="text-sm font-semibold text-green-600">✓ Ativo</span>
                        {% else %}
                        <span class="text-sm font-semibold text-red-600">✗ Desatualizado</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <a href="{% url 'vehicles-detail' trip.vehicle.pk %}" class="mt-4 block text-center text-sm text-blue-600 hover:text-blue-800">
                    Ver Detalhes →
                </a>
            </div>

            <!-- Datas -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Período</h3>
                <div class="space-y-3">
                    <div>
                        <p class="text-xs text-gray-500">Início Planejado</p>
                        <p class="text-sm font-semibold">{{ trip.planned_start_date|date:"d/m/Y H:i" }}</p>
                    </div>
                    {% if trip.actual_start_date %}
                    <div>
                        <p class="text-xs text-gray-500">Início Real</p>
                        <p class="text-sm font-semibold text-green-600">{{ trip.actual_start_date|date:"d/m/Y H:i" }}</p>
                    </div>
                    {% endif %}
                    <div>
                        <p class="text-xs text-gray-500">Término Planejado</p>
                        <p class="text-sm font-semibold">{{ trip.planned_end_date|date:"d/m/Y H:i" }}</p>
                    </div>
                    {% if trip.actual_end_date %}
                    <div>
                        <p class="text-xs text-gray-500">Término Real</p>
                        <p class="text-sm font-semibold text-blue-600">{{ trip.actual_end_date|date:"d/m/Y H:i" }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Carga -->
            {% if trip.cargo_description or trip.cargo_value %}
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Carga</h3>
                {% if trip.cargo_description %}
                <p class="text-sm text-gray-600 mb-2">{{ trip.cargo_description }}</p>
                {% endif %}
                {% if trip.cargo_value %}
                <div class="flex justify-between pt-2 border-t">
                    <span class="text-sm text-gray-600">Valor:</span>
                    <span class="text-sm font-semibold">R$ {{ trip.cargo_value|floatformat:2 }}</span>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Observações -->
            {% if trip.observations %}
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                <h3 class="text-sm font-semibold text-yellow-800 mb-2">Observações</h3>
                <p class="text-sm text-yellow-700">{{ trip.observations }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<script>
var map;
var currentMarker;
var routeLine;

window.addEventListener('load', function() {
    // Inicializar mapa
    var currentLat = parseFloat('{{ current_lat|stringformat:"f" }}');
    var currentLng = parseFloat('{{ current_lng|stringformat:"f" }}');
    
    map = L.map('tracking-map').setView([currentLat, currentLng], 12);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
    }).addTo(map);
    
    // Ícones customizados
    var currentIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    var originIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    var destIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    // Marcador de posição atual
    currentMarker = L.marker([currentLat, currentLng], {icon: currentIcon}).addTo(map);
    currentMarker.bindPopup('<strong>Posição Atual</strong><br>{{ trip.vehicle.plate }}');
    
    // Marcadores de origem e destino
    var originLat = parseFloat('{{ origin_lat|stringformat:"f" }}');
    var originLng = parseFloat('{{ origin_lng|stringformat:"f" }}');
    var destLat = parseFloat('{{ dest_lat|stringformat:"f" }}');
    var destLng = parseFloat('{{ dest_lng|stringformat:"f" }}');
    
    L.marker([originLat, originLng], {icon: originIcon}).addTo(map)
        .bindPopup('<strong>Origem</strong><br>{{ trip.route.origin_name }}');
    
    L.marker([destLat, destLng], {icon: destIcon}).addTo(map)
        .bindPopup('<strong>Destino</strong><br>{{ trip.route.destination_name }}');
    
    // Desenhar rota
    {% if trip.route.route_geometry %}
    try {
        var routeGeometry = {{ trip.route.route_geometry|safe }};
        if (routeGeometry && routeGeometry.coordinates) {
            var routeCoords = routeGeometry.coordinates.map(function(coord) {
                return [coord[1], coord[0]];
            });
            
            routeLine = L.polyline(routeCoords, {
                color: '#3b82f6',
                weight: 4,
                opacity: 0.6,
                dashArray: '10, 5'
            }).addTo(map);
        }
    } catch (e) {
        console.error('Erro ao desenhar rota:', e);
    }
    {% endif %}
    
    // Ajustar zoom
    var bounds = L.latLngBounds([
        [originLat, originLng],
        [destLat, destLng],
        [currentLat, currentLng]
    ]);
    map.fitBounds(bounds, { padding: [50, 50] });
    
    setTimeout(function() {
        map.invalidateSize();
    }, 100);
});

// Função para atualizar posição
function refreshPosition() {
    fetch('{% url "monitoring_refresh_position" trip.pk %}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.position) {
                var newLat = data.position.latitude;
                var newLng = data.position.longitude;
                
                // Atualizar marcador
                currentMarker.setLatLng([newLat, newLng]);
                map.panTo([newLat, newLng]);
                
                // Atualizar informações
                location.reload();
            }
        })
        .catch(error => console.error('Erro ao atualizar posição:', error));
}

// Auto-refresh a cada 30 segundos se estiver em andamento
{% if trip.status == 'EM_ANDAMENTO' %}
setInterval(refreshPosition, 30000);
{% endif %}
</script>
{% endblock %}
