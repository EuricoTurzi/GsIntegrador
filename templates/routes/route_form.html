{% extends 'base.html' %}

{% block title %}{% if route %}Editar Rota{% else %}Nova Rota{% endif %}{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<!-- Leaflet Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<style>
    .leaflet-routing-container {
        display: none !important; /* Hide default routing instructions panel */
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex items-center">
            <a href="{% if route %}{% url 'routes-detail' route.pk %}{% else %}{% url 'routes-list' %}{% endif %}" 
               class="text-gray-500 hover:text-gray-700 mr-3">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="text-3xl font-bold text-gray-800">
                {% if route %}
                    <i class="fas fa-edit text-blue-500 mr-2"></i> Editar Rota
                {% else %}
                    <i class="fas fa-plus-circle text-green-500 mr-2"></i> Nova Rota
                {% endif %}
            </h1>
        </div>
    </div>

    <form method="post" id="routeForm">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Form -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Basic Info -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-6 py-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-info-circle mr-2"></i> Informações Básicas
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                                Nome da Rota <span class="text-red-500">*</span>
                            </label>
                            <input type="text" 
                                   id="name" 
                                   name="name" 
                                   value="{{ route.name|default:'' }}"
                                   required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Ex: São Paulo - Rio de Janeiro">
                        </div>

                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                                Descrição
                            </label>
                            <textarea id="description" 
                                      name="description" 
                                      rows="3"
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                      placeholder="Descreva a rota (opcional)">{{ route.description|default:'' }}</textarea>
                        </div>

                        {% if transportadoras %}
                        <!-- Campo de seleção de transportadora (apenas para GR) -->
                        <div>
                            <label for="transportadora" class="block text-sm font-medium text-gray-700 mb-1">
                                Transportadora <span class="text-red-500">*</span>
                            </label>
                            <select id="transportadora" 
                                    name="transportadora" 
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Selecione uma transportadora</option>
                                {% for transp in transportadoras %}
                                <option value="{{ transp.pk }}" {% if route and route.transportadora_id == transp.pk %}selected{% endif %}>
                                    {{ transp.username }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="is_active" 
                                   name="is_active" 
                                   {% if not route or route.is_active %}checked{% endif %}
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="is_active" class="ml-2 text-sm font-medium text-gray-700">
                                Rota Ativa
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Address Search -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-search-location mr-2"></i> Definir Endereços
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <!-- Instructions -->
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">
                                        <strong>Digite o endereço completo</strong> e clique em "Buscar" para localizar automaticamente no mapa.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Origin Search -->
                        <div>
                            <label for="origin_search" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-map-marker-alt text-green-600 mr-1"></i> Endereço de Origem <span class="text-red-500">*</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" 
                                       id="origin_search" 
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                       placeholder="Ex: Av. Paulista, 1000, São Paulo, SP"
                                       value="{{ route.origin_address|default:'' }}">
                                <button type="button" 
                                        onclick="searchOrigin()" 
                                        class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors font-medium whitespace-nowrap">
                                    <i class="fas fa-search mr-2"></i> Buscar
                                </button>
                            </div>
                            <input type="text" 
                                   id="origin_name" 
                                   name="origin_name" 
                                   value="{{ route.origin_name|default:'' }}"
                                   required
                                   class="mt-2 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                   placeholder="Nome do local (ex: Terminal Central SP)">
                        </div>

                        <!-- Destination Search -->
                        <div>
                            <label for="destination_search" class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-map-marker-alt text-red-600 mr-1"></i> Endereço de Destino <span class="text-red-500">*</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" 
                                       id="destination_search" 
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                       placeholder="Ex: Av. Rio Branco, 100, Rio de Janeiro, RJ"
                                       value="{{ route.destination_address|default:'' }}">
                                <button type="button" 
                                        onclick="searchDestination()" 
                                        class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors font-medium whitespace-nowrap">
                                    <i class="fas fa-search mr-2"></i> Buscar
                                </button>
                            </div>
                            <input type="text" 
                                   id="destination_name" 
                                   name="destination_name" 
                                   value="{{ route.destination_name|default:'' }}"
                                   required
                                   class="mt-2 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                   placeholder="Nome do local (ex: Centro de Distribuição RJ)">
                        </div>

                        <!-- Calculate Route Button -->
                        <button type="button" 
                                onclick="calculateRoute()" 
                                id="calculateBtn"
                                disabled
                                class="w-full px-6 py-3 bg-purple-500 hover:bg-purple-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg transition-colors font-semibold">
                            <i class="fas fa-route mr-2"></i> Calcular Rota
                        </button>
                    </div>
                </div>

                <!-- Interactive Map -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-map-marked-alt mr-2"></i> Visualização da Rota
                        </h2>
                    </div>
                    <div class="p-6">
                        <!-- Route Info -->
                        <div id="route-info" class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 hidden">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-blue-700">
                                        <i class="fas fa-route mr-2"></i>
                                        <strong>Distância:</strong> <span id="route-distance" class="font-bold">-</span> km
                                    </p>
                                </div>
                                <div>
                                    <p class="text-sm text-blue-700">
                                        <i class="fas fa-clock mr-2"></i>
                                        <strong>Tempo:</strong> <span id="route-duration" class="font-bold">-</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Map Container -->
                        <div id="route-map" style="height: 500px;" class="rounded-lg border-2 border-gray-300"></div>
                    </div>
                </div>

                <!-- Hidden Fields -->
                <input type="hidden" id="origin_address" name="origin_address" value="{{ route.origin_address|default:'' }}">
                <input type="hidden" id="origin_latitude" name="origin_latitude" value="{{ route.origin_latitude|default:'' }}">
                <input type="hidden" id="origin_longitude" name="origin_longitude" value="{{ route.origin_longitude|default:'' }}">
                <input type="hidden" id="destination_address" name="destination_address" value="{{ route.destination_address|default:'' }}">
                <input type="hidden" id="destination_latitude" name="destination_latitude" value="{{ route.destination_latitude|default:'' }}">
                <input type="hidden" id="destination_longitude" name="destination_longitude" value="{{ route.destination_longitude|default:'' }}">
                <input type="hidden" id="route_geometry" name="route_geometry" value='{{ route.route_geometry|default:"" }}'>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Actions -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden sticky top-6">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-6 py-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-save mr-2"></i> Ações
                        </h2>
                    </div>
                    <div class="p-4 space-y-2">
                        <button type="submit" 
                                class="w-full px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors font-semibold">
                            <i class="fas fa-check mr-2"></i>
                            {% if route %}Salvar Alterações{% else %}Criar Rota{% endif %}
                        </button>
                        <a href="{% if route %}{% url 'routes-detail' route.pk %}{% else %}{% url 'routes-list' %}{% endif %}" 
                           class="block w-full text-center px-4 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors font-semibold">
                            <i class="fas fa-times mr-2"></i> Cancelar
                        </a>
                    </div>
                </div>

                <!-- Help -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-6 py-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-question-circle mr-2"></i> Como Usar
                        </h2>
                    </div>
                    <div class="p-6 space-y-3 text-sm text-gray-700">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-6 h-6 bg-green-100 rounded-full flex items-center justify-center mr-2 mt-0.5">
                                <span class="text-green-600 font-bold text-xs">1</span>
                            </div>
                            <p>Digite o endereço de <strong class="text-green-600">origem</strong> e clique em "Buscar"</p>
                        </div>
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-6 h-6 bg-red-100 rounded-full flex items-center justify-center mr-2 mt-0.5">
                                <span class="text-red-600 font-bold text-xs">2</span>
                            </div>
                            <p>Digite o endereço de <strong class="text-red-600">destino</strong> e clique em "Buscar"</p>
                        </div>
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mr-2 mt-0.5">
                                <span class="text-purple-600 font-bold text-xs">3</span>
                            </div>
                            <p>Clique em <strong class="text-purple-600">"Calcular Rota"</strong> para traçar o caminho nas estradas</p>
                        </div>
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-2 mt-0.5">
                                <span class="text-blue-600 font-bold text-xs">4</span>
                            </div>
                            <p><strong>Arraste a rota no mapa</strong> para ajustar o caminho passando por outros locais</p>
                        </div>
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-6 h-6 bg-green-100 rounded-full flex items-center justify-center mr-2 mt-0.5">
                                <span class="text-green-600 font-bold text-xs">5</span>
                            </div>
                            <p>Clique em <strong class="text-green-600">"Salvar"</strong> para criar a rota com todas as modificações</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
<!-- Leaflet Routing Machine -->
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    // Initialize map
    var map = L.map('route-map').setView([-23.550520, -46.633308], 5);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
    }).addTo(map);
    
    // Custom icons
    var greenIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    var redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    // State
    var originMarker = null;
    var destMarker = null;
    var routingControl = null;
    
    // Nominatim geocoding
    async function geocodeAddress(address) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=br&limit=1`,
                {
                    headers: {
                        'User-Agent': 'IntegradorApp/1.0'
                    }
                }
            );
            const data = await response.json();
            
            if (data && data.length > 0) {
                return {
                    latitude: parseFloat(data[0].lat),
                    longitude: parseFloat(data[0].lon),
                    formatted_address: data[0].display_name
                };
            }
            throw new Error('Endereço não encontrado');
        } catch (error) {
            console.error('Geocoding error:', error);
            throw error;
        }
    }
    
    // Search origin
    async function searchOrigin() {
        const address = document.getElementById('origin_search').value.trim();
        if (!address) {
            alert('Por favor, digite um endereço de origem');
            return;
        }
        
        try {
            const result = await geocodeAddress(address);
            
            document.getElementById('origin_address').value = result.formatted_address;
            document.getElementById('origin_latitude').value = parseFloat(result.latitude).toFixed(7);
            document.getElementById('origin_longitude').value = parseFloat(result.longitude).toFixed(7);
            
            if (originMarker) {
                map.removeLayer(originMarker);
            }
            
            originMarker = L.marker([result.latitude, result.longitude], {
                icon: greenIcon,
                draggable: true
            }).addTo(map);
            
            originMarker.bindPopup('<strong class="text-green-600">Origem</strong><br>' + result.formatted_address).openPopup();
            
            map.setView([result.latitude, result.longitude], 13);
            
            originMarker.on('dragend', function(e) {
                const latlng = e.target.getLatLng();
                document.getElementById('origin_latitude').value = latlng.lat.toFixed(7);
                document.getElementById('origin_longitude').value = latlng.lng.toFixed(7);
                checkRouteReady();
            });
            
            checkRouteReady();
            
            alert('✅ Origem localizada! ' + result.formatted_address.substring(0, 50) + '...');
            
        } catch (error) {
            alert('❌ Erro ao buscar endereço: ' + error.message + '\n\nTente ser mais específico (ex: Rua, Número, Cidade, Estado)');
        }
    }
    
    // Search destination
    async function searchDestination() {
        const address = document.getElementById('destination_search').value.trim();
        if (!address) {
            alert('Por favor, digite um endereço de destino');
            return;
        }
        
        try {
            const result = await geocodeAddress(address);
            
            document.getElementById('destination_address').value = result.formatted_address;
            document.getElementById('destination_latitude').value = parseFloat(result.latitude).toFixed(7);
            document.getElementById('destination_longitude').value = parseFloat(result.longitude).toFixed(7);
            
            if (destMarker) {
                map.removeLayer(destMarker);
            }
            
            destMarker = L.marker([result.latitude, result.longitude], {
                icon: redIcon,
                draggable: true
            }).addTo(map);
            
            destMarker.bindPopup('<strong class="text-red-600">Destino</strong><br>' + result.formatted_address).openPopup();
            
            if (originMarker) {
                const bounds = L.latLngBounds([originMarker.getLatLng(), destMarker.getLatLng()]);
                map.fitBounds(bounds, { padding: [50, 50] });
            } else {
                map.setView([result.latitude, result.longitude], 13);
            }
            
            destMarker.on('dragend', function(e) {
                const latlng = e.target.getLatLng();
                document.getElementById('destination_latitude').value = latlng.lat.toFixed(7);
                document.getElementById('destination_longitude').value = latlng.lng.toFixed(7);
                checkRouteReady();
            });
            
            checkRouteReady();
            
            alert('✅ Destino localizado! ' + result.formatted_address.substring(0, 50) + '...');
            
        } catch (error) {
            alert('❌ Erro ao buscar endereço: ' + error.message + '\n\nTente ser mais específico (ex: Rua, Número, Cidade, Estado)');
        }
    }
    
    // Check if route can be calculated
    function checkRouteReady() {
        const btn = document.getElementById('calculateBtn');
        if (originMarker && destMarker) {
            btn.disabled = false;
            btn.classList.remove('bg-gray-300', 'cursor-not-allowed');
            btn.classList.add('bg-purple-500', 'hover:bg-purple-600');
        }
    }
    
    // Calculate route
    function calculateRoute() {
        if (!originMarker || !destMarker) {
            alert('Por favor, defina origem e destino primeiro');
            return;
        }
        
        if (routingControl) {
            map.removeControl(routingControl);
        }
        
        routingControl = L.Routing.control({
            waypoints: [
                originMarker.getLatLng(),
                destMarker.getLatLng()
            ],
            routeWhileDragging: true,
            showAlternatives: false,
            addWaypoints: true,
            lineOptions: {
                styles: [{color: '#3b82f6', opacity: 0.7, weight: 5}]
            },
            createMarker: function() { return null; }
        }).addTo(map);
        
        routingControl.on('routesfound', function(e) {
            const route = e.routes[0];
            const distanceKm = (route.summary.totalDistance / 1000).toFixed(2);
            const durationMin = Math.round(route.summary.totalTime / 60);
            const durationHours = (durationMin / 60).toFixed(1);
            
            document.getElementById('route-distance').textContent = distanceKm;
            document.getElementById('route-duration').textContent = durationHours + 'h';
            document.getElementById('route-info').classList.remove('hidden');
            
            const coordinates = route.coordinates.map(c => [c.lng, c.lat]);
            document.getElementById('route_geometry').value = JSON.stringify({
                type: 'LineString',
                coordinates: coordinates
            });
            
            console.log('Rota calculada:', distanceKm + 'km', durationHours + 'h');
        });
    }
    
    // Form validation
    document.getElementById('routeForm').addEventListener('submit', function(e) {
        const originLat = document.getElementById('origin_latitude').value;
        const originLng = document.getElementById('origin_longitude').value;
        const destLat = document.getElementById('destination_latitude').value;
        const destLng = document.getElementById('destination_longitude').value;
        
        if (!originLat || !originLng || !destLat || !destLng) {
            e.preventDefault();
            alert('❌ Por favor, defina a origem e o destino antes de salvar.');
            return false;
        }
    });
</script>
{% endblock %}
